## Project Structure & Boundaries

### Complete Project Directory Structure

Since this is a **brownfield integration** into the existing gastown Go CLI tool, the structure shows:
- Existing gastown architecture (high-level summary)
- New crosstown packages (detailed)
- Modified/extended files
- New test and configuration infrastructure

```
gastown/
├── cmd/
│   └── gt/
│       └── main.go                          # [EXISTING] Entry point (unchanged)
│
├── internal/                                 # [EXISTING] All implementation code (58 packages)
│   │
│   ├── cmd/                                  # [EXISTING] CLI commands (50+ existing)
│   │   ├── crosstown.go                     # [NEW] Crosstown command group
│   │   ├── mayor.go                         # [MODIFIED] Add crosstown dashboard panel
│   │   └── ...                              # [EXISTING] Other 50+ commands
│   │
│   ├── ilp/                                  # [NEW PACKAGE] ILP/BTP protocol implementation
│   │   ├── client.go                        # BTP WebSocket client (connector communication)
│   │   ├── client_test.go                   # Unit tests (gomock)
│   │   ├── rpc.go                           # Base Sepolia RPC client (HTTP)
│   │   ├── rpc_test.go                      # RPC tests
│   │   ├── spsp.go                          # SPSP handshake handler
│   │   ├── spsp_test.go                     # SPSP tests
│   │   ├── types.go                         # ILP types, constants, errors
│   │   ├── integration_test.go              # Integration tests (build tag: integration)
│   │   └── mocks/
│   │       └── mock_connector_client.go     # Generated by gomock
│   │
│   ├── nostr/                                # [NEW PACKAGE] NIP-01 WebSocket + TOON
│   │   ├── relay.go                         # NIP-01 WebSocket client (relay communication)
│   │   ├── relay_test.go                    # Unit tests (gomock)
│   │   ├── encoding.go                      # TOON encoding (using toon-go fork)
│   │   ├── encoding_test.go                 # TOON encoding tests
│   │   ├── types.go                         # Nostr types, event kinds, filters
│   │   ├── integration_test.go              # Integration tests (relay + events)
│   │   └── mocks/
│   │       └── mock_relay_client.go         # Generated by gomock
│   │
│   ├── crosstown/                            # [NEW PACKAGE] Integration layer
│   │   ├── channel_manager.go               # Payment channel state management
│   │   ├── channel_manager_test.go          # Channel manager tests
│   │   ├── job_tracker.go                   # Job correlation tracker (git-backed)
│   │   ├── job_tracker_test.go              # Job correlation tests
│   │   ├── wallet.go                        # Wallet, Argon2 key derivation
│   │   ├── wallet_test.go                   # Wallet tests
│   │   ├── config.go                        # Configuration structs, validation
│   │   ├── config_test.go                   # Configuration tests
│   │   ├── types.go                         # Crosstown types, constants, errors
│   │   ├── e2e_test.go                      # E2E tests (full flow with containers)
│   │   └── testdata/
│   │       ├── channel_state.toml           # Test fixture
│   │       └── encrypted_key.txt            # Test fixture
│   │
│   ├── mayor/                                # [EXISTING] Mayor orchestration
│   │   ├── dashboard.go                     # [MODIFIED] Add crosstown panel (Bubbletea)
│   │   ├── dashboard_crosstown.go           # [NEW] Crosstown panel UI logic
│   │   ├── dashboard_crosstown_test.go      # [NEW] Crosstown panel tests
│   │   ├── skills/                          # [EXISTING] Skills system (unchanged)
│   │   └── ...                              # [EXISTING] Other mayor components
│   │
│   └── ...                                   # [EXISTING] Other 53 packages (unchanged)
│
├── docs/                                     # [EXISTING] Documentation (42+ docs)
│   ├── crosstown-integration.md             # [NEW] Crosstown integration guide
│   └── ...                                  # [EXISTING] Other docs
│
├── .github/
│   └── workflows/
│       ├── ci.yml                           # [MODIFIED] Add crosstown integration tests
│       └── ...                              # [EXISTING] Other 9 workflows
│
├── docker-compose.test.yml                   # [NEW] Crosstown containers for E2E tests
├── Dockerfile.e2e                            # [MODIFIED] Add crosstown relay + connector
│
├── go.mod                                    # [MODIFIED] Add dependencies:
├── go.sum                                    #   - github.com/gorilla/websocket
│                                             #   - github.com/ALLiDoizCode/toon-go
│                                             #   - golang.org/x/crypto/argon2
│                                             #   - github.com/golang/mock (test only)
│
├── Makefile                                  # [MODIFIED] Add crosstown test targets
├── README.md                                 # [EXISTING] No changes needed
└── ...                                       # [EXISTING] Other root files

# Runtime Structure (Git Worktree-Backed State)

~/.gt/hooks/mayor-001/                        # [EXISTING] Mayor git worktree
├── crosstown/                                # [NEW] Crosstown state directory
│   ├── channels/                            # [NEW] Payment channel TOML files
│   │   ├── ch_7f3a9b2e.toml                # Channel state (0600 permissions)
│   │   └── ch_abc456f.toml                 # Another channel state
│   ├── jobs/                                # [NEW] Job correlation state
│   │   ├── job-5abc123.toml                # Job mapping (job_id → callback_skill)
│   │   └── job-def456.toml                 # Another job mapping
│   ├── crosstown.log                        # [NEW] Crosstown operations log
│   └── payment_log.jsonl                    # [NEW] Structured payment audit log
│
└── .git/                                     # [EXISTING] Git for audit trail
    └── logs/                                # Git commits for channel state changes
```

---

### Architectural Boundaries

This is a Go CLI tool with no external HTTP/REST APIs. Boundaries are **internal Go package interfaces** and **external service integrations**.

#### **API Boundaries (Internal Go Package Interfaces)**

**NostrRelayClient Interface** (`internal/nostr/`)
```go
type NostrRelayClient interface {
    Connect(ctx context.Context, relayURL string) error
    Subscribe(ctx context.Context, filters []Filter) (<-chan []byte, error)
    Publish(ctx context.Context, event []byte) error
    Close() error
}
```
- **Used by**: `internal/crosstown/` (job posting, event subscription)
- **Implements**: `internal/nostr/relay.go`
- **Mocked in tests**: `internal/nostr/mocks/mock_relay_client.go`

**ILPConnectorClient Interface** (`internal/ilp/`)
```go
type ILPConnectorClient interface {
    Handshake(ctx context.Context) error
    SendPrepare(ctx context.Context, packet []byte) ([]byte, error)
    Close() error
}
```
- **Used by**: `internal/crosstown/` (payment sending)
- **Implements**: `internal/ilp/client.go`
- **Mocked in tests**: `internal/ilp/mocks/mock_connector_client.go`

**ChannelManager Interface** (`internal/crosstown/`)
```go
type ChannelManager interface {
    OpenChannel(ctx context.Context, deposit string) (*ChannelState, error)
    UpdateBalance(ctx context.Context, channelID string, newBalance string, jobID string) error
    CloseChannel(ctx context.Context, channelID string) error
    GetChannel(channelID string) (*ChannelState, error)
    ListChannels() ([]*ChannelState, error)
}
```
- **Used by**: `internal/cmd/crosstown.go`, `internal/mayor/dashboard_crosstown.go`
- **Implements**: `internal/crosstown/channel_manager.go`
- **Mocked in tests**: Unit tests for CLI commands and dashboard

---

#### **Component Boundaries**

Go package boundaries define components:

**Package: `internal/ilp/`**
- **Responsibility**: BTP protocol, ILP packet handling, SPSP handshake, Base Sepolia RPC
- **Dependencies**: gorilla/websocket, net/http, crypto libraries
- **Exports**: `ILPConnectorClient` interface, `RPCClient` interface, ILP types
- **Communication**: Called by `internal/crosstown/` for payment operations

**Package: `internal/nostr/`**
- **Responsibility**: NIP-01 WebSocket, TOON encoding/decoding, event filtering
- **Dependencies**: gorilla/websocket, github.com/ALLiDoizCode/toon-go
- **Exports**: `NostrRelayClient` interface, TOON encoding functions, event types
- **Communication**: Called by `internal/crosstown/` for relay operations

**Package: `internal/crosstown/`**
- **Responsibility**: Integration layer, channel management, job correlation, wallet/encryption
- **Dependencies**: `internal/ilp/`, `internal/nostr/`, golang.org/x/crypto/argon2
- **Exports**: `ChannelManager`, `JobTracker`, `Wallet`, crosstown types
- **Communication**: Called by `internal/cmd/crosstown.go` and `internal/mayor/dashboard_crosstown.go`

**Package: `internal/cmd/`** (existing, extended)
- **Responsibility**: CLI command definitions (Cobra)
- **Dependencies**: `internal/crosstown/`, `internal/mayor/`, all domain packages
- **Exports**: Cobra commands
- **Communication**: Entry point from `cmd/gt/main.go`

**Package: `internal/mayor/`** (existing, extended)
- **Responsibility**: Mayor orchestration, dashboard (Bubbletea), skills system
- **Dependencies**: `internal/crosstown/` (new), Bubbletea, existing domain packages
- **Exports**: Mayor runtime, dashboard UI
- **Communication**: Launched by `gt mayor attach` command

---

#### **Service Boundaries (External Integrations)**

**Crosstown Relay** (WebSocket, NIP-01)
- **Client**: `internal/nostr/relay.go`
- **Protocol**: NIP-01 (Nostr Basic Protocol)
- **Transport**: WebSocket (ws:// or wss://)
- **Default URL**: `ws://relay.crosstown.network`
- **Override**: `GASTOWN_CROSSTOWN_RELAY_URL`
- **Reconnection**: Exponential backoff (1s→30s, jitter)

**Crosstown Connector** (WebSocket, BTP)
- **Client**: `internal/ilp/client.go`
- **Protocol**: BTP (Bilateral Transfer Protocol) over ILPv4
- **Transport**: WebSocket (btp+ws://)
- **Default URL**: `btp+ws://connector.crosstown.network:3000`
- **Override**: `GASTOWN_CROSSTOWN_CONNECTOR_BTP`
- **Retry**: Max 3 retries with exponential backoff

**Base Sepolia RPC** (HTTP, Web3 JSON-RPC)
- **Client**: `internal/ilp/rpc.go`
- **Protocol**: Ethereum JSON-RPC (eth_call, eth_getTransactionReceipt, etc.)
- **Transport**: HTTP/HTTPS
- **Default URL**: `https://sepolia.base.org`
- **Override**: `GASTOWN_BASE_SEPOLIA_RPC`
- **Purpose**: On-chain channel state recovery, transaction submission

---

#### **Data Boundaries**

**Git Worktree Storage** (Primary Persistence)
- **Location**: `~/.gt/hooks/mayor-001/crosstown/`
- **Format**: TOML files (channels, jobs)
- **Access Pattern**: Read/write via file operations, commit to git after each state change
- **Serialization**: Git operations MUST be serialized (not thread-safe, existing gastown constraint)
- **Permissions**: 0600 for all channel state files (NFR-S5)
- **Crash Recovery**: Git history provides tamper-evident audit trail and state recovery

**TOML Configuration Files**
- **Channel State**: `~/.gt/hooks/mayor-001/crosstown/channels/<channel_id>.toml`
- **Job Correlation**: `~/.gt/hooks/mayor-001/crosstown/jobs/<job_id>.toml`
- **Format**: TOML (consistent with gastown pattern)
- **Validation**: Schema validation on load (ensure required fields present)

**Structured Logs**
- **Payment Audit Log**: `~/.gt/hooks/mayor-001/crosstown/payment_log.jsonl` (JSONL, 30-day rotation)
- **Operations Log**: `~/.gt/hooks/mayor-001/crosstown.log` (text, key-value format)
- **Access**: Append-only, rotation via log management
- **Export**: CSV/JSON export commands (`gt crosstown export`)

**In-Memory State** (Ephemeral)
- **Private Key**: Held in memory only during Mayor session (NFR-S2), cleared on shutdown
- **WebSocket Connections**: Active relay/connector connections
- **Bubbletea Model**: Dashboard state (derived from git-backed TOML files)

---

### Requirements to Structure Mapping

**Explicit mapping from 58 Functional Requirements to specific files and directories:**

#### **Relay Communication (FR1-FR5)**
- **FR1** (WebSocket subscription): `internal/nostr/relay.go` (Connect, Subscribe methods)
- **FR2** (TOON event reception): `internal/nostr/relay.go` (event channel from Subscribe)
- **FR3** (Automatic reconnection): `internal/nostr/relay.go` (reconnectWithBackoff method)
- **FR4** (Connection status): `internal/mayor/dashboard_crosstown.go` (Bubbletea panel)
- **FR5** (Multiple event kinds): `internal/nostr/types.go` (Filter struct, kind array)

#### **Payment Channel Management (FR6-FR14)**
- **FR6** (Wallet config): `internal/crosstown/wallet.go` (LoadWallet, Argon2 key derivation)
- **FR7** (Encrypted private key): `internal/crosstown/wallet.go` (AES-256-GCM encrypt/decrypt)
- **FR8** (SPSP handshake): `internal/ilp/spsp.go` (PerformHandshake method)
- **FR9** (Channel opening): `internal/crosstown/channel_manager.go` (OpenChannel method)
- **FR10** (Base Sepolia testnet): `internal/ilp/rpc.go` (chainID: 84532, M2M contract: 0x39ea...)
- **FR11** (Git-backed state): `internal/crosstown/channel_manager.go` (persistChannelState writes TOML + git commit)
- **FR12** (Balance monitoring): `internal/crosstown/channel_manager.go` (UpdateBalance method, threshold checking)
- **FR13** (Configurable limits): `internal/crosstown/config.go` (MaxChannelBalanceM2M field)
- **FR14** (On-chain recovery): `internal/ilp/rpc.go` (RecoverChannelState method, query blockchain)

#### **Job Coordination (FR15-FR26)**
- **FR15** (DVM job requests): `internal/nostr/encoding.go` (ConstructJobRequest using toon-go)
- **FR16-18** (ILP PREPARE): `internal/ilp/client.go` (SendPrepare method)
- **FR19** (FULFILL/REJECT): `internal/ilp/client.go` (handle response types)
- **FR20** (Job correlation): `internal/crosstown/job_tracker.go` (MapJob, GetJob methods, TOML persistence)
- **FR21** (Result routing): `internal/crosstown/job_tracker.go` (RouteResult method, skill invocation)
- **FR22-23** (Sequential chains): `internal/crosstown/job_tracker.go` (ChainJobs method, dependency tracking)
- **FR24** (Crash-resistant state): `internal/crosstown/job_tracker.go` (git commit after each job mapping)
- **FR25** (Polecat execution): `internal/mayor/` (existing, integration with job_tracker.RouteResult)
- **FR26** (Job cleanup): `internal/crosstown/job_tracker.go` (CleanupCompletedJobs method)

#### **TOON Event Processing (FR27-FR32)**
- **FR27** (Zero-parse pattern): `internal/nostr/relay.go` (return raw []byte from Subscribe)
- **FR28** (LLM interpretation): `internal/mayor/skills/` (existing, receives raw TOON bytes)
- **FR29** (kind extraction): `internal/nostr/encoding.go` (ExtractEventKind lightweight function)
- **FR30-31** (Skill invocation): `internal/crosstown/job_tracker.go` (RouteResult → skills system)
- **FR32** (Error handling): `internal/nostr/encoding.go` (ExtractEventKind returns error for invalid TOON)

#### **Configuration & Setup (FR33-FR38)**
- **FR33** (Environment vars): `internal/crosstown/config.go` (LoadConfig reads env vars)
- **FR34** (Config priority): `internal/crosstown/config.go` (CLI flags → env → file → defaults)
- **FR35** (Private key encryption): `internal/crosstown/wallet.go` (ConfigureWallet CLI command triggers encryption)
- **FR36** (Runtime passphrase): `internal/cmd/crosstown.go` (promptPassphrase, secure input)
- **FR37** (Validation): `internal/crosstown/config.go` (Validate method, check required fields)
- **FR38** (Error messages): `internal/crosstown/config.go` (validation errors with suggestions)

#### **Observability & Monitoring (FR39-FR45)**
- **FR39** (Bubbletea dashboard): `internal/mayor/dashboard_crosstown.go` (Crosstown panel, Bubbletea MVU)
- **FR40** (Git audit trail): `internal/crosstown/channel_manager.go` (git commit after each balance update)
- **FR41** (Structured logging): `internal/crosstown/channel_manager.go`, `job_tracker.go` (payment_log.jsonl writes)
- **FR42** (CSV/JSON export): `internal/cmd/crosstown.go` (export subcommand, read payment_log.jsonl)
- **FR43** (Payment statistics): `internal/cmd/crosstown.go` (stats subcommand, parse payment_log.jsonl)
- **FR44** (Network identification): `internal/mayor/dashboard_crosstown.go` (display "TESTNET" prominently)
- **FR45** (Error reporting): `internal/mayor/dashboard_crosstown.go` (error panel in Bubbletea UI)

#### **CLI Operations (FR46-FR54)**
- **FR46** (Interactive mode): `internal/cmd/crosstown.go` + `internal/mayor/dashboard.go` (existing Mayor integration)
- **FR47** (Wallet management): `internal/cmd/crosstown.go` (wallet subcommands: configure, show)
- **FR48** (Channel management): `internal/cmd/crosstown.go` (channel subcommands: open, close, list, show)
- **FR49** (Relay management): `internal/cmd/crosstown.go` (relay subcommands: connect, disconnect, status)
- **FR50** (Payment history): `internal/cmd/crosstown.go` (history subcommand, read payment_log.jsonl)
- **FR51** (Multi-format output): `internal/cmd/crosstown.go` (--output flag: text, json, csv)
- **FR52** (Non-interactive): `internal/cmd/crosstown.go` (all commands support --non-interactive flag)
- **FR53** (Shell completion): `internal/cmd/crosstown.go` (Cobra auto-generates completion)
- **FR54** (Help text): `internal/cmd/crosstown.go` (Cobra Long/Short descriptions)

#### **Skills Extensibility (FR55-FR58)**
- **FR55** (Zero-config registration): `internal/mayor/skills/` (existing, no changes needed)
- **FR56** (Auto-discovery): `internal/mayor/skills/` (existing, scans `.claude/skills/`)
- **FR57** (Raw TOON handling): `internal/crosstown/job_tracker.go` (RouteResult passes raw bytes to skills)
- **FR58** (No Mayor changes): Design satisfied (job_tracker.RouteResult integrates with existing skills API)

---

### Integration Points

#### **Internal Communication Patterns**

**CLI → Crosstown Manager**
```go
// internal/cmd/crosstown.go
func runChannelOpenCommand(cmd *cobra.Command, args []string) error {
    ctx := context.Background()

    // Load configuration
    config, err := crosstown.LoadConfig()
    if err != nil {
        return fmt.Errorf("failed to load config: %w", err)
    }

    // Create channel manager
    manager := crosstown.NewChannelManager(config)

    // Open channel
    channel, err := manager.OpenChannel(ctx, depositAmount)
    if err != nil {
        return fmt.Errorf("failed to open channel: %w", err)
    }

    fmt.Printf("Channel opened: %s\n", channel.ID)
    return nil
}
```

**Crosstown Manager → ILP Client**
```go
// internal/crosstown/channel_manager.go
func (cm *ChannelManager) OpenChannel(ctx context.Context, deposit string) (*ChannelState, error) {
    // Perform SPSP handshake
    handshakeResult, err := cm.ilpClient.Handshake(ctx)
    if err != nil {
        return nil, fmt.Errorf("SPSP handshake failed: %w", err)
    }

    // Create channel state
    state := &ChannelState{
        ID:         generateChannelID(),
        Balance:    deposit,
        Status:     ChannelStatusOpen,
        ConnectorBTP: handshakeResult.ConnectorURL,
    }

    // Persist to git-backed TOML
    if err := cm.persistChannelState(state); err != nil {
        return nil, err
    }

    return state, nil
}
```

**Job Tracker → Skills System**
```go
// internal/crosstown/job_tracker.go
func (jt *JobTracker) RouteResult(ctx context.Context, jobID string, toonBytes []byte) error {
    // Get job mapping from git-backed TOML
    jobMapping, err := jt.GetJob(jobID)
    if err != nil {
        return fmt.Errorf("job not found: %w", err)
    }

    // Invoke skill with raw TOON bytes (zero-parse pattern)
    return jt.skillsSystem.InvokeSkill(ctx, jobMapping.CallbackSkill, toonBytes)
}
```

**Dashboard → Crosstown Manager (Bubbletea Messages)**
```go
// internal/mayor/dashboard_crosstown.go
func (m CrosstownModel) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    switch msg := msg.(type) {
    case ChannelBalanceUpdatedMsg:
        // Immutable update (MVU pattern)
        newChannels := make(map[string]ChannelState)
        for k, v := range m.channels {
            newChannels[k] = v
        }
        newChannels[msg.ChannelID] = ChannelState{
            Balance: msg.CurrentBalance,
        }

        return CrosstownModel{
            channels: newChannels,
            connected: m.connected,
        }, nil
    }
}
```

---

#### **External Integrations**

**Crosstown Relay (NIP-01 WebSocket)**
```go
// internal/nostr/relay.go
func (rc *RelayClient) Subscribe(ctx context.Context, filters []Filter) (<-chan []byte, error) {
    // Connect WebSocket
    conn, _, err := websocket.DefaultDialer.DialContext(ctx, rc.relayURL, nil)
    if err != nil {
        return nil, fmt.Errorf("WebSocket dial failed: %w", err)
    }

    // Send REQ message (NIP-01)
    reqMsg := constructREQMessage(filters)
    if err := conn.WriteMessage(websocket.TextMessage, reqMsg); err != nil {
        return nil, err
    }

    // Return channel for events
    eventChan := make(chan []byte, 100)
    go rc.readEvents(ctx, conn, eventChan)

    return eventChan, nil
}
```

**Crosstown Connector (BTP over WebSocket)**
```go
// internal/ilp/client.go
func (ic *ILPConnectorClient) SendPrepare(ctx context.Context, packet []byte) ([]byte, error) {
    // BTP packet framing
    btpPacket := frameBTPPacket(BTPMessageTypePREPARE, packet)

    // Send via WebSocket
    if err := ic.conn.WriteMessage(websocket.BinaryMessage, btpPacket); err != nil {
        return nil, fmt.Errorf("BTP send failed: %w", err)
    }

    // Wait for FULFILL or REJECT response
    response, err := ic.waitForResponse(ctx, BTPMessageTypeFULFILL, BTPMessageTypeREJECT)
    if err != nil {
        return nil, err
    }

    return response, nil
}
```

**Base Sepolia RPC (HTTP JSON-RPC)**
```go
// internal/ilp/rpc.go
func (rc *RPCClient) RecoverChannelState(ctx context.Context, channelID string) (*ChannelState, error) {
    // Construct eth_call request
    callData := constructEthCall("getChannelState", channelID)

    // Send HTTP request
    req, err := http.NewRequestWithContext(ctx, "POST", rc.rpcURL, bytes.NewReader(callData))
    if err != nil {
        return nil, err
    }

    resp, err := rc.httpClient.Do(req)
    if err != nil {
        return nil, fmt.Errorf("RPC request failed: %w", err)
    }
    defer resp.Body.Close()

    // Parse response
    var result ChannelState
    if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
        return nil, err
    }

    return &result, nil
}
```

---

#### **Data Flow**

**Complete Payment Flow (FR6-FR26)**

```
1. User runs: gt crosstown channel open --deposit 50.00

2. CLI Command (internal/cmd/crosstown.go)
   ↓ calls crosstown.NewChannelManager()

3. Channel Manager (internal/crosstown/channel_manager.go)
   ↓ calls wallet.DecryptPrivateKey(passphrase)

4. Wallet (internal/crosstown/wallet.go)
   ↓ Argon2id(passphrase, salt) → AES-256-GCM decrypt
   ↓ returns private key (held in memory)

5. Channel Manager
   ↓ calls ilpClient.Handshake()

6. SPSP Handler (internal/ilp/spsp.go)
   ↓ HTTP request to connector's SPSP endpoint
   ↓ receives connector details (BTP URL, settlement info)

7. Channel Manager
   ↓ creates ChannelState struct
   ↓ calls persistChannelState()

8. Persistence Layer
   ↓ writes ~/.gt/hooks/mayor-001/crosstown/channels/ch_7f3a9b2e.toml
   ↓ git add ch_7f3a9b2e.toml
   ↓ git commit -m "crosstown: payment channel ch_7f3a9b2e opened\n\nDeposit: 50.00 M2M\n..."

9. Return to User
   ↓ Display: "Channel opened: ch_7f3a9b2e (Balance: 50.00 M2M)"
```

**Job Execution Flow (FR15-FR32)**

```
1. Mayor receives work request (existing gastown workflow)
   ↓
2. Mayor decides to distribute to crosstown network
   ↓ calls jobTracker.CreateJob()

3. Job Tracker (internal/crosstown/job_tracker.go)
   ↓ generates job_id
   ↓ creates job mapping: job_id → callback_skill
   ↓ persists to ~/.gt/hooks/mayor-001/crosstown/jobs/job-5abc123.toml
   ↓ git commit (audit trail)

4. Job Tracker
   ↓ calls nostrClient.Publish(kind:5xxx event)

5. Nostr Relay Client (internal/nostr/relay.go)
   ↓ calls encoding.ConstructJobRequest(payload)

6. TOON Encoding (internal/nostr/encoding.go)
   ↓ uses toon-go fork to encode payload
   ↓ constructs kind:5xxx Nostr event

7. Nostr Relay Client
   ↓ WebSocket send EVENT message to relay

8. Relay broadcasts event to crosstown network
   [External: Polecat picks up job, executes, publishes result]

9. Nostr Relay Client
   ↓ receives kind:6xxx result event (raw TOON bytes)
   ↓ calls encoding.ExtractEventKind() (lightweight, <1ms)
   ↓ routes to jobTracker.RouteResult()

10. Job Tracker
    ↓ reads job mapping from git-backed TOML
    ↓ calls skillsSystem.InvokeSkill(callback_skill, raw TOON bytes)

11. Skills System (internal/mayor/skills/, existing)
    ↓ passes raw TOON bytes to Claude Code for LLM-native interpretation
    ↓ executes skill logic

12. Cleanup
    ↓ jobTracker.CleanupCompletedJobs()
    ↓ delete job mapping TOML
    ↓ git commit (audit trail)
```

---

### File Organization Patterns

#### **Configuration Files**

**Root Level (Build & Project Config)**
- `go.mod` / `go.sum` - Go module dependencies (add gorilla/websocket, toon-go, argon2)
- `Makefile` - Build orchestration (add `test-crosstown`, `test-e2e-crosstown` targets)
- `docker-compose.test.yml` - E2E test containers (crosstown relay + connector)
- `Dockerfile.e2e` - E2E test image (modified to include crosstown services)

**Crosstown-Specific Config (Runtime)**
- Environment variables: `GASTOWN_CROSSTOWN_*` (relay URL, connector URL, RPC endpoint)
- Encrypted private key: `GASTOWN_WALLET_PRIVATE_KEY_ENCRYPTED` (base64-encoded AES-GCM blob)
- Channel state: `~/.gt/hooks/mayor-001/crosstown/channels/*.toml` (git-backed, 0600 permissions)
- Job mappings: `~/.gt/hooks/mayor-001/crosstown/jobs/*.toml` (git-backed)

---

#### **Source Organization**

**Package Structure (follows existing gastown patterns)**

```
internal/<package>/
  ├── <package>.go           # Main implementation
  ├── <package>_test.go      # Unit tests (gomock)
  ├── types.go               # Types, constants, errors
  ├── config.go              # Configuration (if applicable)
  ├── integration_test.go    # Integration tests (build tag: integration)
  ├── testdata/              # Test fixtures
  └── mocks/                 # Generated mocks (gomock)
      └── mock_*.go
```

**Crosstown Packages**
- `internal/ilp/` - ILP protocol implementation (BTP client, SPSP, RPC)
- `internal/nostr/` - Nostr protocol implementation (relay client, TOON encoding)
- `internal/crosstown/` - Integration layer (channel manager, job tracker, wallet)

**Existing Packages (Extended)**
- `internal/cmd/` - Add `crosstown.go` command group
- `internal/mayor/` - Add `dashboard_crosstown.go` Bubbletea panel

---

#### **Test Organization**

**Unit Tests** (`*_test.go` alongside source)
- Use gomock for interface mocking
- Coverage target: ≥50% per package
- Run with: `go test ./internal/ilp/ ./internal/nostr/ ./internal/crosstown/`

**Integration Tests** (`integration_test.go`, build tag: `integration`)
- Use real crosstown containers (relay + connector)
- Test end-to-end flows (SPSP handshake, job posting, payment)
- Run with: `go test -tags=integration ./internal/crosstown/`

**E2E Tests** (`e2e_test.go`, Docker only)
- Full user journey validation (Journey 1: Mayor CI/CD build)
- Requires `docker-compose.test.yml` services running
- Run with: `make test-e2e-container` (existing gastown pattern, extended)

**Test Fixtures** (`testdata/`)
- Sample channel state TOML files
- Encrypted key test data
- Mock TOON event payloads

---

#### **Asset Organization**

**Static Assets**
- None (CLI tool, no web UI or static assets)

**Dynamic Assets (Runtime)**
- Channel state TOML files: `~/.gt/hooks/mayor-001/crosstown/channels/`
- Job mapping TOML files: `~/.gt/hooks/mayor-001/crosstown/jobs/`
- Structured logs: `~/.gt/hooks/mayor-001/crosstown.log`, `payment_log.jsonl`

---

### Development Workflow Integration

#### **Development Server Structure**

No development server (CLI tool). Development workflow:

```bash
# Build with version info (NEVER use `go build` directly)
make build

# Install to ~/.local/bin (NEVER use `go install`)
make install

# Run gastown with crosstown integration
gt install ~/gt-test --git
cd ~/gt-test
gt rig add test-project /path/to/repo
gt crew add dev --rig test-project
cd test-project/crew/dev

# Configure crosstown wallet
export GASTOWN_WALLET_PRIVATE_KEY_ENCRYPTED="<base64-blob>"

# Attach Mayor (will prompt for passphrase)
gt mayor attach
```

---

#### **Build Process Structure**

**Makefile Targets (Extended)**

```makefile
# [EXISTING] Build binary with version ldflags
build:
	go build -ldflags "-X main.Version=$(VERSION) -X main.Commit=$(COMMIT)" -o bin/gt cmd/gt/main.go

# [EXISTING] Run unit tests
test:
	go test ./...

# [NEW] Run crosstown-specific unit tests with coverage
test-crosstown:
	go test -cover ./internal/ilp/ ./internal/nostr/ ./internal/crosstown/

# [NEW] Run integration tests (requires crosstown containers)
test-integration-crosstown:
	docker-compose -f docker-compose.test.yml up -d
	go test -tags=integration ./internal/crosstown/
	docker-compose -f docker-compose.test.yml down

# [MODIFIED] Run E2E tests in Docker (add crosstown services)
test-e2e-container:
	docker build -f Dockerfile.e2e -t gastown-test .
	docker-compose -f docker-compose.test.yml up --abort-on-container-exit

# [NEW] Generate mocks (gomock)
generate-mocks:
	mockgen -source=internal/ilp/client.go -destination=internal/ilp/mocks/mock_connector_client.go
	mockgen -source=internal/nostr/relay.go -destination=internal/nostr/mocks/mock_relay_client.go
```

---

#### **Deployment Structure**

**Deployment Channels (Existing)**
- GitHub Releases (binary downloads) - No changes needed
- Homebrew (`brew install gastown`) - Formula updated automatically via release
- NPM (`npm install -g @gastown/gt`) - NPM wrapper updated automatically

**Crosstown-Specific Deployment Notes**
- No separate deployment needed (integrated into gastown binary)
- Users configure crosstown via environment variables post-install
- Documentation added: `docs/crosstown-integration.md`
